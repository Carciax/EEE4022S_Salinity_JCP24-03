% ----------------------------------------------------
% Methodology
% ----------------------------------------------------

\chapter{Salinometer Evaluation and Testing}\label{ch:testing}

The \gls{pcb} boards were delivered and tested.
Some design errors were found which include using op-amps that were rated for 6V instead of 3V3, missing a connection between VDDA and VCC, and footprints errors with both the temperature sensor and depth sensor.
The temperature sensor footprint was unable to be corrected, but the depth sensor could be corrected by flipping the depth sensor.

Once the circuitry was working and coded, the salinometer was tested.
The testing was conducted in two phases.
One phase before the probe was cast into epoxy resin and the other after the probe was cast into epoxy resin (section numbers?).
A summary of these tests is shown in~\reftbl{tab:testing-summary} and each test is discussed in further detail in the following sections.

The equipment used to verify these tests were a bench multimeter model Keysight U3401A which had voltage accuracy to $0.02\%$ and resistance accuracy to $0.1\%$.
% \textit{insert picutres, adc config, dac step, r^2 values}.

%chktex-file 44
\begin{longtblr}[
        caption = {A summary of the evaluation and testing of the salinometer.},
        label = {tab:testing-summary}
    ]{
        colspec = {|Q[c,m,1cm]|X[c,m]|*{3}{Q[c,m,1.75cm]|}}
    }
    \hline
    \textbf{Sec.} & \textbf{Test Description} & \textbf{Result Metric} & \textbf{Ideal Result} & \textbf{Measured Results} \\
    \hline
    \ref{sec:dac-voltage-range-and-accuracy} & The minimum and maximum voltage output of the \gls{dac} between $0V$ and $V_{DD} = 3.3V$ & Range & $0-3.3V$ & $0-2.59V$ \\
    \hline
    \ref{sec:dac-voltage-range-and-accuracy} & The gain and offset of the output voltage of the \gls{dac} relative to the instructed voltage & {Gain \\ Offset} & {$1.0$ \\ $0.0V$} & {$0.9837$ \\ $0.0070V$} \\
    \hline
    \ref{sec:adc-accuracy} & The gain and offset of the voltage measured by the \gls{adc} relative to the voltage measured by the multimeter & {Gain \\ Offset} & {$1.0$ \\ $0.0V$} & {$0.9877$ \\ $0.0082V$} \\
    \hline
    \ref{sec:calibration-resistance} & The resistance of the calibration resistor $R_{CAL}$ & Resistance & $5\Omega$ & $5.00\Omega$ \\
    \hline
    \ref{sec:resistance-measuring-accuracy} & The gain and offset of the resistance measured by the salinometer relative to the resistance measured by the multimeter & {Gain \\ Offset} & {$1$ \\ $0\Omega$} & {$1.0000$ \\ $0.0000\Omega$} \\
    \hline
    % Linear Conductivity Measurement Au & Whether the sample of salt water had linear conductivity throughout a range of voltages or not using the gold electrodes with no fringe shield & Non-linear &  \\
    % \hline
    % Linear Conductivity Measurement Shielded Au & Whether the sample of salt water had linear conductivity throughout a range of voltages or not using the gold electrodes with the fringe shield & Linear & \\
    % \hline
    % Linear Conductivity Measurement Ti & Whether the sample of salt water had linear conductivity throughout a range of voltages or not using the titanium electrodes & Non-Linear & \\
    % \hline
    % Titanium Voltage to Conductivity Mapping Accuracy & How accurately the relationship between the voltage output by the DAC and the voltage measured over the titanium electrodes can correlate to a specific conductivity & $100\%$ accuracy & \\
    % \hline
    % Salinity Measurement Accuracy & The salinometer's average accuracy in measuring salinity & $100\%$ & \\
    % \hline
\end{longtblr}

\section{DAC Voltage Range and Accuracy}\label{sec:dac-voltage-range-and-accuracy}

The \gls{dac} configuration uses a transistor in order to buffer the \gls{dac} output which allows for the power draw to be support by the transistor instead of the \gls{dac}.
This is a common configuration where the \gls{dac} is connected to the non-inverting input of an op-amp whose output is connected to the base of an NPN transistor.
The emitter of the transistor is then connected to the inverting input of the op-amp which allows the buffered output to match the input of the \gls{dac}.

This configuration does have one disadvantage in that the output voltage of the \gls{dac} is limited by the transistor's $V_{BE}$ such that the highest voltage output at the emitter of the transistor is $V_{DD} - V_{BE}$.
According to the transistor's \href{https://www.lcsc.com/datasheet/lcsc_datasheet_2310131500_Jiangsu-Changjing-Electronics-Technology-Co---Ltd--S8050-J3Y-RANGE-200-350_C2146.pdf}{data sheet}, the buffered output should be limited to $3.3V - 0.6V = 2.7V$ when conducting $0A$ and $3.3V - 0.75V = 2.55V$ when conducting the maximum current of $33mA$ when the load is $100\Omega$.
In order to assess the range and accuracy of the \gls{dac}, the \gls{dac} was instructed to output voltages from $0V$ to $V_{DD}$ in intervals of 64-bits and the output voltage was measured at the base and emitter of the buffer transistor and under maximum load of $100\Omega$ and no load.
$V_{DD}$ and $GND$ were measured to be $3.299V$ and $0V$ respectively.

\begin{figure}[!ht]
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Testing/DAC_no_load}
        \caption{The input voltage versus the output voltage of the \gls{dac} with no load.}
        \label{fig:dac-voltage-range-no-load} %chktex 24
    \end{minipage}%
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Testing/DAC_loaded}
        \caption{The input voltage versus the output voltage of the \gls{dac} with a load of $100\Omega$.}
        \label{fig:dac-voltage-range-loaded} %chktex 24
    \end{minipage}
\end{figure}

The results were graphed and are shown in~\reffig{fig:dac-voltage-range-no-load} and~\reffig{fig:dac-voltage-range-loaded}.
The voltage drop as a result $V_{BE}$ can clearly be seen on~\reffig{fig:dac-voltage-range-loaded}.
The unloaded output voltage was able to reach $2.83V$ and the loaded output voltage was able to reach $2.59V$ which are slightly higher than the predicted limits.

An alternate attempt was also made to achieve a higher voltage output by using the internal reference voltage of the \gls{dac}.
The internal reference voltage was set to $4 \times 1.21V = 4.84V$ and the \gls{dac} was instructed to output the maximum voltage.
As expected, this was not able to increase the output voltage; the base of the transistor still outputted $3.3V$ and the emitter still outputted $2.83V$ while unloaded.

Due to the voltage limitations, the \gls{dac} will have a limited output in future testing and implementation to prevent the output voltage not reaching the desired input voltage.
The output will be limited to $0V$ to $2.5V$ or $0$ to $775$ for fully loaded tests and the implementation and $0V$ to $2.7$ or $0$ to $837$ for unloaded tests.
When excluding the voltage readings above $2.5V$, the \gls{dac} was able to achieve a gain of $0.9837V/V$ and an offset $+0.0070V$ between the input voltage and output voltage when under maximum load. 

\section{ADC Accuracy}\label{sec:adc-accuracy}

The \gls{adc} will be tested by measuring a range of voltages produced by the \gls{dac} and comparing the voltage measured by a multimeter to the voltage measured by the \gls{adc}.
The \gls{adc} will be configured in 12-bit mode with each measurement taking 15 \gls{adc} clock cycles and 5 measurements will be taken and averaged to increase the accuracy of the measurement.
The accuracy of the \gls{adc} should ideally be $100\%$.

\begin{figure}[!ht]
    \centering
    \includegraphics[width=0.5\textwidth]{Figures/Testing/ADC}
    \caption{The voltage output by the \gls{dac} measured by a multimeter versus measured by the \gls{adc}.}
    \label{fig:adc-accuracy} %chktex 24
\end{figure}

The results are shown in~\reffig{fig:adc-accuracy}. 
The \gls{adc} achieved a gain of $0.9877V/V$ and an offset of $0.0082V$ when compared to the multimeter.

\section{Calibration Resistance}\label{sec:calibration-resistance}

The calibration resistor will be measured by using the multimeter and by using the \gls{adc} with and without the gain applied.
The calibration resistance was specified to be $5\Omega \pm 0.25\%$, and thus it is expected to be between $4.9875$ and $5.0125\Omega$.

The calibration resistors were electrically disconnected, and the multimeter was used to measure the calibration resistor to be $5.25\Omega$ when the probes where applied directly across one of the parallel calibration resistor's terminals.
The multimeter cables measured $0.25\Omega$ when connected to each other and thus the final resistance of the calibration resistor was $5.00\Omega$.
It should be noted that the multimeter could only measure down to $0.01\Omega$ and thus the true resistance could range from $4.99\Omega$ to $5.01\Omega$.


\section{Resistance Measuring Accuracy}\label{sec:resistance-measuring-accuracy}

The method of measuring resistance involves getting a voltage reading of the calibration resistor and a sample resistor which is attached between the titanium electrode ports.
The resistance of the sample resistor is then calculated using the ratio between the voltage across the sample resistor and the calibration resistor.

This will be done using two methods: one with a single voltage from the \gls{dac} of $V_{DD}/2 = 1.65V$ and one with voltage sweep from the \gls{dac} with $50$ samples.
It was noticed during the testing phase that low voltage readings were not accurate as single bit errors caused large changes in the resistance reading and thus the range of voltages will be limited to $0.3V$ to $2.6V$ or $93$ to $806$ bits.
Both measurements will then be compared to the resistance measured by the multimeter.
The range of the resistors used will be $0\Omega$ to $10\Omega$ as this is the expected range for the gold electrodes.

\begin{figure}[!ht]
    \centering
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Testing/R_uncorrected}
        \caption{The resistance measuring test.}
        \label{fig:resistance-measuring-accuracy-uncorrected} %chktex 24
    \end{minipage}%
    \begin{minipage}{.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Testing/R_corrected}
        \caption{The resistance measuring test using the corrected equation.}
        \label{fig:resistance-measuring-accuracy-corrected} %chktex 24
    \end{minipage}
\end{figure}

The results are shown in~\reffig{fig:resistance-measuring-accuracy-uncorrected}. 
The single voltage method and voltage sweep method were perfectly correlated with an $r^2$ value of $1.0000$, however there was a clear error between the actual resistance and the resistance measured by the salinometer.
This error was assumed to be due to the resistance of the switches and the traces.
While these values could be measured and corrected for, a more efficient and arguably more accurate method would be to generate a curve of best fit and use this to correct the resistance readings.

In order to generate the equation of best fit, the voltage ratio \refeqn{eqn:electrode-calib-resistance} is adjusted to include $r_e$ which represents the resistance of the switches and traces as shown in \refeqn{eqn:resistance-measuring}.
The $R_{calibration}$, $R_1$ and $r_e$ are condensed into the standard rational function coefficients $p$ and $q$ as shown in \refeqn{eqn:resistance-rational}.
Finally, the equation is rearranged to give the resistance of the electrode in terms the measured voltage ratio as shown in \refeqn{eqn:resistance-measuring-rational}.

\begin{align}
    V_{ratio} &= \lfrac{\lfrac{R_{electrode} + r_{e1}}{R_{electrode} + R_1 + r_{e2}}}{\lfrac{R_{calibration} + r_{e3}}{R_{calibration} + R_1 + r_{e4}}} \nonumber \\
    &= \lfrac{R_{electrode} + r_{e1}}{R_{electrode} + R_1 + r_{e2}} \times \lfrac{R_{calibration} + R_1 + r_{e4}}{R_{calibration} + r_{e3}} \label{eqn:resistance-measuring} \\
    V_{ratio} &= \lfrac{p_1 R_{electrode} + p_2}{R_{electrode} + q_1} \label{eqn:resistance-measuring-rational} \\
    R_{electrode} &= \lfrac{p_2 - q_1 V_{ratio}}{V_{ratio} - p_1} \label{eqn:resistance-measuring-rearranged}
\end{align}

The \refeqn{eqn:resistance-measuring-rational} of best fit was confirmed using \texttt{MATLAB} giving $p_1 = 17.4687$, $p_2 = 18.4643$ and $q_1 = 91.8315$ with an $r^2$ value of $1.0000$. 
The corrected resistance values were then obtained by applying \refeqn{eqn:resistance-measuring-rearranged} to the voltage ratios and these results were graphed and are shown in~\reffig{fig:resistance-measuring-accuracy-corrected} with a gain of $1.0000$ and an offset of $0.0000$.
Note that this correction equation is only valid when $R_1$ is $100\Omega$ and separate equations will need to be generated should different values of $R_1$ be needed.

\section{Linear Conductivity Measurement}\label{sec:linear-conductivity-measurement}


dac was linear, calib was linear for all

Initial tests showed that the measurement was non-linear for au electrode however forwards and backwards voltage sweeps are not the same GRAPH
this indicated that the measurement affected the voltage.

to isolate this it was thought that the dac might not be moving the voltage properly and thus the dac was reset and drained and then the voltage was pumped allowing for a longer time for the voltage to settle. 
this did not fix it. GRAPH

the next idea was to do false measurements at max voltage before doing sweeps.
this caused the readings to start high and slowly move to the votlage sweep. GRAPH
this shows that the measurement clearly affects the water by agitating it.
this could be ionising the water, or polarising it or another affected

the next test involved letting it settle between each measurement as in theory this would cause. 
starting at 2s.
this gave two graphs that matched perfecetly for the forward and backwards sweep. GRAPH

waiting 2s per measurement for 50 samples took very long and an alternate method was to change the water infront of the electrodes by agitating/stirring the water.
this gave repeatable results that also showed a difference between two different water samples. GRAPH
taking fewer samples over the more linear voltage range gave something that was approximately linear.

trying to find a decernable metric from these graphs by analysing A/(s+p) between two samples of arbitrary salinity. TABLE

try repeated single measurements.

ac testing not rigged up correctly. GRAPH